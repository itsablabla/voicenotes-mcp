/**
 * VoiceNotes MCP Server v2
 * Full MCP server with D1 database, FTS search, and Craft sync
 */

interface Env {
  DB: D1Database;
  NOTES_KV: KVNamespace;
  MCP_API_KEY: string;
  VOICENOTES_TOKEN: string;
  ANTHROPIC_API_KEY: string;
  CRAFT_MCP_URL?: string;
}

interface Note {
  id: string;
  title: string;
  transcript: string;
  summary?: string;
  duration: number;
  tags: string[];
  created_at: string;
  updated_at: string;
  synced_to_craft: boolean;
  craft_doc_id?: string;
  extraction?: Extraction;
}

interface Extraction {
  people: Person[];
  topics: string[];
  action_items: string[];
  decisions: string[];
  projects: string[];
  key_facts: string[];
  companies: string[];
}

interface Person {
  name: string;
  role?: string;
  context?: string;
  sentiment?: 'positive' | 'negative' | 'neutral';
}

const VOICENOTES_API = 'https://api.voicenotes.com/api/integrations/obsidian-sync';
const ANTHROPIC_API = 'https://api.anthropic.com/v1/messages';
const VOICE_MEMOS_FOLDER = '7853';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
};

// ==================== AUTO-MIGRATION ====================

let migrationRun = false;

async function ensureSchema(env: Env): Promise<void> {
  if (migrationRun) return;

  try {
    // Create tables if they don't exist
    await env.DB.batch([
      env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS notes (
          id TEXT PRIMARY KEY,
          title TEXT NOT NULL,
          transcript TEXT NOT NULL,
          summary TEXT,
          duration INTEGER DEFAULT 0,
          tags TEXT DEFAULT '[]',
          created_at TEXT NOT NULL,
          updated_at TEXT NOT NULL,
          synced_to_craft INTEGER DEFAULT 0,
          craft_doc_id TEXT
        )
      `),
      env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS extractions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          note_id TEXT NOT NULL UNIQUE,
          people TEXT DEFAULT '[]',
          topics TEXT DEFAULT '[]',
          action_items TEXT DEFAULT '[]',
          decisions TEXT DEFAULT '[]',
          projects TEXT DEFAULT '[]',
          key_facts TEXT DEFAULT '[]',
          companies TEXT DEFAULT '[]',
          extracted_at TEXT NOT NULL,
          FOREIGN KEY (note_id) REFERENCES notes(id)
        )
      `),
      env.DB.prepare(`CREATE INDEX IF NOT EXISTS idx_notes_created ON notes(created_at DESC)`),
      env.DB.prepare(`CREATE INDEX IF NOT EXISTS idx_notes_synced ON notes(synced_to_craft)`),
    ]);

    // Create FTS table separately (can't be in batch with IF NOT EXISTS properly)
    try {
      await env.DB.prepare(`
        CREATE VIRTUAL TABLE IF NOT EXISTS notes_fts USING fts5(
          id,
          title,
          transcript,
          summary,
          tags,
          content='notes',
          content_rowid='rowid'
        )
      `).run();
    } catch (e) {
      // FTS table might already exist
    }

    migrationRun = true;
  } catch (error: any) {
    console.error('Migration error:', error);
    // Don't fail completely - some operations might still work
  }
}

// ==================== MCP TOOL DEFINITIONS ====================

const toolDefinitions = [
  {
    name: 'voicenotes_sync',
    description: 'Sync notes from VoiceNotes API to local database. Returns count of new, updated, and skipped notes.',
    inputSchema: {
      type: 'object',
      properties: {
        force: { type: 'boolean', description: 'Force re-sync all notes even if unchanged' }
      }
    }
  },
  {
    name: 'voicenotes_list',
    description: 'List voice notes with optional filters',
    inputSchema: {
      type: 'object',
      properties: {
        limit: { type: 'number', description: 'Max notes to return (default 20)' },
        offset: { type: 'number', description: 'Pagination offset' },
        unsynced_only: { type: 'boolean', description: 'Only show notes not synced to Craft' },
        start_date: { type: 'string', description: 'Filter by date (YYYY-MM-DD)' },
        end_date: { type: 'string', description: 'Filter by end date (YYYY-MM-DD)' },
        tag: { type: 'string', description: 'Filter by tag' }
      }
    }
  },
  {
    name: 'voicenotes_get',
    description: 'Get a single voice note by ID with full transcript and extraction',
    inputSchema: {
      type: 'object',
      properties: {
        id: { type: 'string', description: 'Note ID' }
      },
      required: ['id']
    }
  },
  {
    name: 'voicenotes_search',
    description: 'Full-text search across transcripts using FTS5',
    inputSchema: {
      type: 'object',
      properties: {
        query: { type: 'string', description: 'Search query (supports FTS5 syntax)' },
        limit: { type: 'number', description: 'Max results (default 20)' }
      },
      required: ['query']
    }
  },
  {
    name: 'voicenotes_recent',
    description: 'Get N most recent notes with full transcripts',
    inputSchema: {
      type: 'object',
      properties: {
        count: { type: 'number', description: 'Number of notes to return (default 5, max 20)' },
        include_extractions: { type: 'boolean', description: 'Include AI extractions' }
      }
    }
  },
  {
    name: 'voicenotes_extract',
    description: 'Extract entities from a note using Claude: people, topics, actions, companies',
    inputSchema: {
      type: 'object',
      properties: {
        id: { type: 'string', description: 'Note ID to extract from' },
        force: { type: 'boolean', description: 'Re-extract even if already done' }
      },
      required: ['id']
    }
  },
  {
    name: 'voicenotes_sync_craft',
    description: 'Sync a note to Craft docs (folder 7853). Creates doc with summary, people, actions, and full transcript.',
    inputSchema: {
      type: 'object',
      properties: {
        id: { type: 'string', description: 'Note ID to sync' },
        all_unsynced: { type: 'boolean', description: 'Sync all unsynced notes' }
      }
    }
  },
  {
    name: 'voicenotes_stats',
    description: 'Get statistics: total count, duration, by day, sync status',
    inputSchema: {
      type: 'object',
      properties: {
        days: { type: 'number', description: 'Days to include in daily breakdown (default 7)' }
      }
    }
  },
  {
    name: 'voicenotes_mark_synced',
    description: 'Mark a note as synced to Craft (without actually syncing)',
    inputSchema: {
      type: 'object',
      properties: {
        id: { type: 'string', description: 'Note ID' },
        craft_doc_id: { type: 'string', description: 'Optional Craft document ID' }
      },
      required: ['id']
    }
  },
  {
    name: 'ping',
    description: 'Health check - returns server status and last sync time',
    inputSchema: { type: 'object', properties: {} }
  }
];

// ==================== TOOL IMPLEMENTATIONS ====================

async function voicenotes_sync(env: Env, args: { force?: boolean }): Promise<object> {
  const response = await fetch(`${VOICENOTES_API}/recordings`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${env.VOICENOTES_TOKEN}`,
      'X-API-KEY': env.VOICENOTES_TOKEN,
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`VoiceNotes API error: ${response.status} - ${error}`);
  }

  const data = await response.json() as { data?: any[] };
  const recordings = data.data || [];

  let synced = 0, updated = 0, skipped = 0;

  for (const recording of recordings) {
    const noteId = recording.recording_id || recording.id;

    // Clean HTML from transcript
    const transcript = (recording.transcript || '')
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<[^>]*>/g, '');

    // Skip junk
    if (!transcript || transcript.length < 20 || transcript.includes('eyJ') || transcript.includes('fm2_')) {
      skipped++;
      continue;
    }

    const existing = await env.DB.prepare('SELECT updated_at, synced_to_craft FROM notes WHERE id = ?').bind(noteId).first();

    const note = {
      id: noteId,
      title: recording.title || 'Untitled',
      transcript,
      duration: recording.duration || 0,
      summary: recording.creations?.find((c: any) => c.type === 'summary')?.content || null,
      tags: JSON.stringify((recording.tags || []).map((t: any) => t.name || t)),
      created_at: recording.created_at,
      updated_at: recording.updated_at
    };

    if (existing && !args.force) {
      if (existing.updated_at !== note.updated_at) {
        await env.DB.prepare(`
          UPDATE notes SET title=?, transcript=?, duration=?, summary=?, tags=?, updated_at=?
          WHERE id=?
        `).bind(note.title, note.transcript, note.duration, note.summary, note.tags, note.updated_at, noteId).run();
        updated++;
      } else {
        skipped++;
      }
    } else {
      await env.DB.prepare(`
        INSERT OR REPLACE INTO notes (id, title, transcript, duration, summary, tags, created_at, updated_at, synced_to_craft)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0)
      `).bind(note.id, note.title, note.transcript, note.duration, note.summary, note.tags, note.created_at, note.updated_at).run();

      // Update FTS index
      await env.DB.prepare(`
        INSERT OR REPLACE INTO notes_fts (rowid, title, transcript)
        SELECT rowid, title, transcript FROM notes WHERE id = ?
      `).bind(noteId).run();

      synced++;
    }
  }

  await env.NOTES_KV.put('last_sync', new Date().toISOString());

  return {
    success: true,
    fetched: recordings.length,
    new: synced,
    updated,
    skipped,
    last_sync: new Date().toISOString()
  };
}

async function voicenotes_list(env: Env, args: {
  limit?: number;
  offset?: number;
  unsynced_only?: boolean;
  start_date?: string;
  end_date?: string;
  tag?: string;
}): Promise<object> {
  const limit = Math.min(args.limit || 20, 100);
  const offset = args.offset || 0;

  let query = 'SELECT id, title, duration, summary, tags, created_at, synced_to_craft FROM notes WHERE 1=1';
  const params: any[] = [];

  if (args.unsynced_only) {
    query += ' AND synced_to_craft = 0';
  }
  if (args.start_date) {
    query += ' AND date(created_at) >= ?';
    params.push(args.start_date);
  }
  if (args.end_date) {
    query += ' AND date(created_at) <= ?';
    params.push(args.end_date);
  }
  if (args.tag) {
    query += ' AND tags LIKE ?';
    params.push(`%"${args.tag}"%`);
  }

  query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
  params.push(limit, offset);

  const stmt = env.DB.prepare(query);
  const results = await stmt.bind(...params).all();

  const notes = (results.results || []).map((row: any) => ({
    ...row,
    tags: JSON.parse(row.tags || '[]')
  }));

  const countResult = await env.DB.prepare('SELECT COUNT(*) as count FROM notes').first() as { count: number };

  return {
    notes,
    count: notes.length,
    total: countResult?.count || 0,
    offset,
    limit
  };
}

async function voicenotes_get(env: Env, args: { id: string }): Promise<object> {
  const note = await env.DB.prepare(`
    SELECT n.*, e.extraction
    FROM notes n
    LEFT JOIN extractions e ON n.id = e.note_id
    WHERE n.id = ?
  `).bind(args.id).first() as any;

  if (!note) {
    throw new Error(`Note not found: ${args.id}`);
  }

  return {
    ...note,
    tags: JSON.parse(note.tags || '[]'),
    extraction: note.extraction ? JSON.parse(note.extraction) : null
  };
}

async function voicenotes_search(env: Env, args: { query: string; limit?: number }): Promise<object> {
  const limit = Math.min(args.limit || 20, 100);

  const results = await env.DB.prepare(`
    SELECT n.id, n.title, n.created_at, n.duration,
           snippet(notes_fts, 1, '<mark>', '</mark>', '...', 32) as snippet
    FROM notes_fts
    JOIN notes n ON notes_fts.rowid = n.rowid
    WHERE notes_fts MATCH ?
    ORDER BY rank
    LIMIT ?
  `).bind(args.query, limit).all();

  return {
    query: args.query,
    results: results.results || [],
    count: (results.results || []).length
  };
}

async function voicenotes_recent(env: Env, args: { count?: number; include_extractions?: boolean }): Promise<object> {
  const count = Math.min(args.count || 5, 20);

  let query = args.include_extractions
    ? `SELECT n.*, e.extraction FROM notes n LEFT JOIN extractions e ON n.id = e.note_id ORDER BY n.created_at DESC LIMIT ?`
    : `SELECT * FROM notes ORDER BY created_at DESC LIMIT ?`;

  const results = await env.DB.prepare(query).bind(count).all();

  const notes = (results.results || []).map((row: any) => ({
    ...row,
    tags: JSON.parse(row.tags || '[]'),
    extraction: row.extraction ? JSON.parse(row.extraction) : null
  }));

  return { notes, count: notes.length };
}

async function voicenotes_extract(env: Env, args: { id: string; force?: boolean }): Promise<object> {
  // Check existing extraction
  if (!args.force) {
    const existing = await env.DB.prepare('SELECT extraction FROM extractions WHERE note_id = ?').bind(args.id).first() as any;
    if (existing?.extraction) {
      return { note_id: args.id, extraction: JSON.parse(existing.extraction), cached: true };
    }
  }

  // Get note
  const note = await env.DB.prepare('SELECT title, transcript FROM notes WHERE id = ?').bind(args.id).first() as any;
  if (!note) {
    throw new Error(`Note not found: ${args.id}`);
  }

  // Call Claude
  const prompt = `Analyze this voice memo and extract structured data:

TITLE: ${note.title}
TRANSCRIPT: ${note.transcript}

Return ONLY this JSON structure (no markdown, no explanation):
{
  "people": [{"name": "string", "role": "string or null", "context": "brief context", "sentiment": "positive|negative|neutral"}],
  "topics": ["topic1", "topic2"],
  "action_items": ["action1", "action2"],
  "decisions": ["decision1"],
  "projects": ["project name"],
  "key_facts": ["fact1"],
  "companies": ["company1"],
  "summary": "2-3 sentence summary"
}

Rules:
- Only include people mentioned by name
- Be specific about context
- Return ONLY valid JSON`;

  const response = await fetch(ANTHROPIC_API, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': env.ANTHROPIC_API_KEY,
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!response.ok) {
    throw new Error(`Claude API error: ${response.status}`);
  }

  const data = await response.json() as any;
  const text = data.content[0]?.text || '';

  // Parse JSON from response
  let extraction: Extraction;
  try {
    let jsonStr = text.includes('```json')
      ? text.split('```json')[1].split('```')[0].trim()
      : text.includes('```')
      ? text.split('```')[1].split('```')[0].trim()
      : text;
    extraction = JSON.parse(jsonStr);
  } catch {
    throw new Error('Failed to parse extraction from Claude response');
  }

  // Store extraction
  await env.DB.prepare(`
    INSERT OR REPLACE INTO extractions (note_id, extraction, extracted_at)
    VALUES (?, ?, ?)
  `).bind(args.id, JSON.stringify(extraction), new Date().toISOString()).run();

  return { note_id: args.id, extraction, cached: false };
}

async function voicenotes_sync_craft(env: Env, args: { id?: string; all_unsynced?: boolean }): Promise<object> {
  const CRAFT_API = env.CRAFT_MCP_URL || 'https://mcp.craft.do/links/KvkWq8X8cFZ/mcp';

  const results: any[] = [];

  let notes: any[];
  if (args.all_unsynced) {
    const res = await env.DB.prepare('SELECT * FROM notes WHERE synced_to_craft = 0 LIMIT 10').all();
    notes = res.results || [];
  } else if (args.id) {
    const note = await env.DB.prepare('SELECT * FROM notes WHERE id = ?').bind(args.id).first();
    notes = note ? [note] : [];
  } else {
    throw new Error('Provide either id or all_unsynced=true');
  }

  for (const note of notes) {
    try {
      // Get extraction if exists
      const ext = await env.DB.prepare('SELECT extraction FROM extractions WHERE note_id = ?').bind(note.id).first() as any;
      const extraction = ext?.extraction ? JSON.parse(ext.extraction) : null;

      // Build markdown
      let md = `**Recorded:** ${note.created_at?.split('T')[0]} | **Duration:** ${Math.round(note.duration)}s | **ID:** ${note.id}\n\n`;

      if (extraction?.summary) {
        md += `## Summary\n${extraction.summary}\n\n`;
      }

      if (extraction?.people?.length) {
        md += `## People Mentioned\n`;
        extraction.people.forEach((p: Person) => {
          md += `- **${p.name}**${p.role ? ` (${p.role})` : ''} - ${p.context || 'mentioned'}\n`;
        });
        md += '\n';
      }

      if (extraction?.action_items?.length) {
        md += `## Action Items\n`;
        extraction.action_items.forEach((a: string) => { md += `- [ ] ${a}\n`; });
        md += '\n';
      }

      if (extraction?.decisions?.length) {
        md += `## Decisions\n`;
        extraction.decisions.forEach((d: string) => { md += `- ${d}\n`; });
        md += '\n';
      }

      md += `## Full Transcript\n${note.transcript}\n`;

      // Create Craft document
      const createResp = await fetch(CRAFT_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 1,
          method: 'tools/call',
          params: {
            name: 'documents_create',
            arguments: {
              destination: { folderId: VOICE_MEMOS_FOLDER },
              documents: [{ title: note.title }]
            }
          }
        })
      });

      if (!createResp.ok) {
        throw new Error(`Craft create failed: ${createResp.status}`);
      }

      const createData = await createResp.json() as any;
      const docId = createData.result?.content?.[0]?.text
        ? JSON.parse(createData.result.content[0].text).documents?.[0]?.id
        : null;

      if (!docId) {
        throw new Error('No document ID returned from Craft');
      }

      // Add content
      await fetch(CRAFT_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 2,
          method: 'tools/call',
          params: {
            name: 'markdown_add',
            arguments: {
              markdown: md,
              position: { pageId: docId, position: 'end' }
            }
          }
        })
      });

      // Mark as synced
      await env.DB.prepare('UPDATE notes SET synced_to_craft = 1, craft_doc_id = ? WHERE id = ?').bind(docId, note.id).run();

      results.push({ id: note.id, title: note.title, craft_doc_id: docId, success: true });
    } catch (e: any) {
      results.push({ id: note.id, title: note.title, success: false, error: e.message });
    }
  }

  return { synced: results.filter(r => r.success).length, failed: results.filter(r => !r.success).length, results };
}

async function voicenotes_stats(env: Env, args: { days?: number }): Promise<object> {
  const days = args.days || 7;

  const total = await env.DB.prepare('SELECT COUNT(*) as count, SUM(duration) as duration FROM notes').first() as any;
  const unsynced = await env.DB.prepare('SELECT COUNT(*) as count FROM notes WHERE synced_to_craft = 0').first() as any;
  const extracted = await env.DB.prepare('SELECT COUNT(*) as count FROM extractions').first() as any;

  const byDay = await env.DB.prepare(`
    SELECT date(created_at) as date, COUNT(*) as count, SUM(duration) as duration
    FROM notes
    WHERE created_at >= date('now', '-' || ? || ' days')
    GROUP BY date(created_at)
    ORDER BY date DESC
  `).bind(days).all();

  const lastSync = await env.NOTES_KV.get('last_sync');

  return {
    total_notes: total?.count || 0,
    total_duration_seconds: total?.duration || 0,
    total_duration_formatted: formatDuration(total?.duration || 0),
    unsynced_to_craft: unsynced?.count || 0,
    extracted: extracted?.count || 0,
    last_sync: lastSync,
    by_day: byDay.results || []
  };
}

async function voicenotes_mark_synced(env: Env, args: { id: string; craft_doc_id?: string }): Promise<object> {
  const note = await env.DB.prepare('SELECT id FROM notes WHERE id = ?').bind(args.id).first();
  if (!note) {
    throw new Error(`Note not found: ${args.id}`);
  }

  await env.DB.prepare('UPDATE notes SET synced_to_craft = 1, craft_doc_id = ? WHERE id = ?')
    .bind(args.craft_doc_id || null, args.id).run();

  return { success: true, id: args.id, synced_to_craft: true };
}

async function ping(env: Env): Promise<object> {
  const lastSync = await env.NOTES_KV.get('last_sync');
  const noteCount = await env.DB.prepare('SELECT COUNT(*) as count FROM notes').first() as any;

  return {
    status: 'ok',
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    last_sync: lastSync,
    note_count: noteCount?.count || 0
  };
}

// ==================== HELPERS ====================

function formatDuration(seconds: number): string {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  if (hours > 0) return `${hours}h ${minutes}m`;
  return `${minutes}m`;
}

function json(data: object, status = 200): Response {
  return new Response(JSON.stringify(data, null, 2), {
    status,
    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
  });
}

// ==================== MCP PROTOCOL ====================

async function handleMcpRequest(request: Request, env: Env): Promise<Response> {
  const body = await request.json() as any;
  const { method, params, id } = body;

  try {
    let result: any;

    if (method === 'initialize') {
      result = {
        protocolVersion: '2024-11-05',
        serverInfo: { name: 'voicenotes-mcp', version: '2.0.0' },
        capabilities: { tools: {} }
      };
    } else if (method === 'tools/list') {
      result = { tools: toolDefinitions };
    } else if (method === 'tools/call') {
      const toolName = params.name;
      const toolArgs = params.arguments || {};

      const tools: Record<string, Function> = {
        voicenotes_sync,
        voicenotes_list,
        voicenotes_get,
        voicenotes_search,
        voicenotes_recent,
        voicenotes_extract,
        voicenotes_sync_craft,
        voicenotes_stats,
        voicenotes_mark_synced,
        ping
      };

      if (!tools[toolName]) {
        throw new Error(`Unknown tool: ${toolName}`);
      }

      const toolResult = await tools[toolName](env, toolArgs);
      result = {
        content: [{ type: 'text', text: JSON.stringify(toolResult, null, 2) }]
      };
    } else {
      throw new Error(`Unknown method: ${method}`);
    }

    return json({ jsonrpc: '2.0', id, result });
  } catch (error: any) {
    return json({
      jsonrpc: '2.0',
      id,
      error: { code: -32000, message: error.message }
    }, 500);
  }
}

// ==================== SSE TRANSPORT ====================

function handleSSE(env: Env): Response {
  const { readable, writable } = new TransformStream();
  const writer = writable.getWriter();
  const encoder = new TextEncoder();

  // Send initial ready event
  (async () => {
    await writer.write(encoder.encode(`data: ${JSON.stringify({ type: 'ready', serverInfo: { name: 'voicenotes-mcp', version: '2.0.0' } })}\n\n`));

    // Keep-alive pings
    const interval = setInterval(() => {
      writer.write(encoder.encode(': ping\n\n')).catch(() => clearInterval(interval));
    }, 30000);
  })();

  return new Response(readable, {
    headers: {
      ...corsHeaders,
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  });
}

// ==================== WEBHOOK HANDLER ====================

async function handleWebhook(request: Request, env: Env): Promise<Response> {
  const body = await request.json() as any;

  // VoiceNotes sends webhook when new recording is ready
  if (body.event === 'recording.ready' || body.recording_id) {
    // Trigger a sync
    const result = await voicenotes_sync(env, {});
    return json({ received: true, sync_result: result });
  }

  return json({ received: true });
}

// ==================== MAIN HANDLER ====================

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);
    const path = url.pathname;

    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    // Health check (no auth)
    if (path === '/health') {
      return json({ status: 'ok', version: '2.0.0', timestamp: new Date().toISOString() });
    }

    // Auth check for all other endpoints
    const apiKey = request.headers.get('Authorization')?.replace('Bearer ', '') ||
                   url.searchParams.get('key');

    if (apiKey !== env.MCP_API_KEY) {
      return json({ error: 'Unauthorized' }, 401);
    }

    // Ensure database schema exists
    await ensureSchema(env);

    try {
      // SSE endpoint for Claude
      if (path === '/sse') {
        return handleSSE(env);
      }

      // MCP JSON-RPC endpoint
      if (path === '/mcp' && request.method === 'POST') {
        return handleMcpRequest(request, env);
      }

      // Webhook for VoiceNotes
      if (path === '/webhook' && request.method === 'POST') {
        return handleWebhook(request, env);
      }

      // Direct REST endpoints for debugging/testing
      if (path === '/tools') {
        return json({ tools: toolDefinitions });
      }

      if (path === '/call' && request.method === 'POST') {
        const body = await request.json() as any;
        const tools: Record<string, Function> = {
          voicenotes_sync,
          voicenotes_list,
          voicenotes_get,
          voicenotes_search,
          voicenotes_recent,
          voicenotes_extract,
          voicenotes_sync_craft,
          voicenotes_stats,
          voicenotes_mark_synced,
          ping
        };

        const toolName = body.name?.replace('voicenotes_', '').replace('voicenotes:', '');
        const fullName = `voicenotes_${toolName}`;
        const fn = tools[fullName] || tools[body.name];

        if (!fn) {
          return json({ error: `Unknown tool: ${body.name}` }, 404);
        }

        const result = await fn(env, body.arguments || {});
        return json(result);
      }

      return json({
        error: 'Not found',
        endpoints: [
          'GET /health - Health check',
          'GET /sse?key=KEY - SSE connection for Claude',
          'POST /mcp - MCP JSON-RPC endpoint',
          'POST /webhook - VoiceNotes webhook receiver',
          'GET /tools - List available tools',
          'POST /call - Direct tool execution'
        ]
      }, 404);
    } catch (error: any) {
      return json({ error: error.message, stack: error.stack }, 500);
    }
  }
};
